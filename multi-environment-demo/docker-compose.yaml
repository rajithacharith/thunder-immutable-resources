version: '3.8'

services:
  thunder:
    image: thunder:latest
    container_name: thunder-${ENV:-dev}
    ports:
      - "${PORT:-8090}:${PORT:-8090}"
    environment:
      - PORT=${PORT:-8090}
      - DB_TYPE=${DB_TYPE:-sqlite}
      - DB_PATH=${DB_PATH:-/app/data/thunder.db}
      - IMMUTABLE_ENABLED=${IMMUTABLE_ENABLED:-false}
      - IMMUTABLE_APPS_PATH=${IMMUTABLE_APPS_PATH:-/opt/thunder/repository/conf/immutable_resources/applications}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - THUNDER_SKIP_SECURITY=true
    env_file:
      - environments/${ENV:-dev}.env
    volumes:
      # Deployment configuration (uses deployment-dev.yaml or deployment-prod.yaml)
      - ./environments/deployment-${ENV:-dev}.yaml:/opt/thunder/repository/conf/deployment.yaml:ro
      
      # Database (for dev environment)
      - thunder-data-${ENV:-dev}:/app/data
      
      # Immutable configurations (for prod environment)
      - ./configs:/opt/thunder/repository/conf/immutable_resources:ro
    networks:
      - thunder-network
    healthcheck:
      test: ["CMD", "curl", "-k", "https://localhost:${PORT:-8090}/health/readiness"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 10s

  sample-app:
    image: thunder-oauth-sample:latest
    container_name: sample-app-${ENV:-dev}
    ports:
      - "${SAMPLE_APP_PORT:-3000}:${SAMPLE_APP_PORT:-3000}"
    environment:
      - PORT=${SAMPLE_APP_PORT:-3000}
      - NODE_ENV=production
      - APP_ID=${APP_ID}
      - FLOW_ENDPOINT=${FLOW_ENDPOINT}
      - APPLICATIONS_ENDPOINT=${APPLICATIONS_ENDPOINT}
      - AUTHORIZATION_ENDPOINT=${AUTHORIZATION_ENDPOINT}
      - TOKEN_ENDPOINT=${TOKEN_ENDPOINT}
      - REDIRECT_URI=${REDIRECT_URI}
    volumes:
      - ./environments/runtime-${ENV:-dev}.json:/app/app/runtime.json:ro
    entrypoint: ["node", "server.js"]
    networks:
      - thunder-network
    depends_on:
      thunder:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  thunder-network:
    driver: bridge

volumes:
  thunder-data-dev:
  thunder-data-prod:
